# Классификация сокращений сердца на базе MIT-BIH (ECG Classification)

## Общая информация

### Постановка задачи

По данным записи электрокардиограммы определить отсутствие или наличие аритмии.

<details><summary>Были выделены основные классы:</summary>

1. N (Normal): Нормальный ритм и нормальные сокращения.

1. S (Supraventricular): Наджелудочковые эктопические сокращения.

1. V (Ventricular): Желудочковые сокращения.

1. F (Fusion): Сливные сокращения (комбинация нормального и желудочкового импульсов).

1. Q (Unknown/Paced): Неизвестные типы сокращений или работа кардиостимулятора.
</details>

### Формат входных и выходных данных

Входные данные: два файла записи электрокардиограммы в формате _.hea и _.dat с количеством отведений от 1 до 2.

Выходные данные: текстовые данные результата поиска аритмии (N, S, V, F, Q).

### Метрики

Для простоты будут использоваться графики по метрике Accuracy.

Результат, на который ориентируемся: acc >= 0.9.

### Данные

Данные датасета MIT-BIH, 48 записей 47 персон по 30 минут каждая.

Дисбаланс классов низкий, представленность сопоставима на уровне записей, на уровне сокращений дисбаланс классов в сторону нормальных (N) сокращений.

## Настройка окружения

### Предварительные требования:

[Python>=3.12](https://www.python.org/downloads/release/python-3120/ "Или напиши в браузере и скачай")

Пакет <b>uv</b>. Если не установлен:

```sh
pip install uv
```

[Также желательно установить git и авторизоваться](https://github.com/git-guides/install-git)

## Развертывание

### Клонирование репозитория:

Переходим в папку, куда будет скачан проект, пишем:

```sh
git clone https://github.com/evrey1917/deep-ecg-2025.git
cd deep-ecg-2025
```

### Создание окружения и установка зависимостей:

```sh
uv sync
```

### Активация окружения:

Windows (в Visual Studio Code открыть терминал cmd):

```sh
.venv\Scripts\activate
```

Linux/macOS:

```sh
source .venv/bin/activate
```

### Настройка инструментов качества кода:

```sh
uv run pre-commit install
```

### Подключение к облаку S3:

KEY_ID и ACCESS_KEY запрашиваются у руководителя проекта

```sh
uv run dvc remote modify storage --local access_key_id <KEY_ID>
uv run dvc remote modify storage --local secret_access_key <ACCESS_KEY>
```

### Получение датасета:

ОБЯЗАТЕЛЬНО выполнить предыдущий шаг

```sh
dvc pull
```

## Обучение

Процесс обучения разделен на этапы подготовки данных и запуска тренировочного цикла. Конфигурация осуществляется через Hydra.

### Этап 1: Препроцессинг и синхронизация (DVC)

Скрипт preprocess.py выполняет следующие действия:

Извлекает сегменты сигнала вокруг R-пиков (окно 187 отсчетов).

Нормализует амплитуду сигнала в диапазон [0, 1].

Сохраняет обработанные тензоры в data/processed/.

Запуск:

```sh
uv run python src/preprocess.py
```

### Этап 2: Тренировка модели

Запуск основного цикла обучения с использованием PyTorch Lightning и логированием в MLflow.
Запуск:

```sh
uv run python src/train.py
```

Для работы логирования предварительно запустите сервер MLflow:

```sh
mlflow server --port 8080
```

После обучения файл весов сохраняется в формате \*.ckpt для дальнейшего использования.

## Экспорт модели

Для использования модели в реальных приложениях предусмотрена процедура экспорта.

Экспорт в ONNX:

```sh
uv run python src/export.py
```

Вход: models/last.ckpt

Выход: models/ecg_model.onnx

## Предсказание

Скрипт инференса работает напрямую с медицинскими форматами записей (.hea/.dat)

```sh
uv run python src/infer.py
```

Для изменения файла для анализа следует изменить конфигурацию:

```sh
configs/infer/infer.yaml
```

Изменить номер в конце input_path для выбора конкретного файла

## Логирование и результаты

Графики: В директории plots/ находятся актуальные кривые Loss и Accuracy.

MLflow: В интерфейсе доступны гиперпараметры, метрики и Git Commit ID каждого запуска.
